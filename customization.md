# Customizing Maudlin Workflow Functions

Maudlin provides a flexible framework for customizing workflows through unit-specific functions. These functions allow you to influence data preprocessing, target generation, and post-processing tasks, ensuring that the model can handle specific requirements and outputs effectively.

## Workflow Functions Overview

Each Maudlin unit includes a set of default workflow functions stored in the directory:

```
MAUDLIN_DATA_DIR/functions
```

These functions can be modified to meet the needs of specific projects:

- **Input Function** - Prepares input features for training or prediction.
- **Target Function** - Generates target labels for supervised learning tasks.
- **Pre-Training Function** - Executes any preprocessing or transformations before training.
- **Post-Training Function** - Handles results processing, reporting, or visualizations after training.
- **Pre-Prediction Function** - Prepares the input features before making predictions.
- **Post-Prediction Function** - Processes the outputs generated by the model during inference.

---

## Input Function

**Purpose:** Prepares the input features for each row in the dataset.

**Default Location:**

```
MAUDLIN_DATA_DIR/functions/input_function.py
```

**Example:**

```python
from keras.saving import register_keras_serializable

@register_keras_serializable(package="CustomPackage")
def apply(config, featurized_df, i, timesteps, target_period):
    # Extract the required time steps
    X = featurized_df.iloc[i - timesteps + 1:i + 1]
    return X.values
```

---

## Target Function

**Purpose:** Creates target values corresponding to the input features.

**Default Location:**

```
MAUDLIN_DATA_DIR/functions/target_function.py
```

**Example:**

```python
from keras.saving import register_keras_serializable

@register_keras_serializable(package="CustomPackage")
def apply(config, features_df, i, timesteps, target_period):
    # Predict the value at target_period
    y = features_df.iloc[i + target_period]['target_column']
    return y
```

---

## Pre-Training Function

**Purpose:** Prepares data or configurations before training begins.

**Default Location:**

```
MAUDLIN_DATA_DIR/functions/pre_training_function.py
```

**Example:**

```python
def apply(config, data_dir, X_train, y_train, X_test, y_test, X_val, y_val):
    # Example: Normalize input features
    from sklearn.preprocessing import StandardScaler
    scaler = StandardScaler()
    X_train = scaler.fit_transform(X_train)
    X_test = scaler.transform(X_test)
    X_val = scaler.transform(X_val)
    return X_train, y_train, X_test, y_test, X_val, y_val
```

---

## Post-Training Function

**Purpose:** Handles reporting, metrics computation, and saving outputs after training.

**Default Location:**

```
MAUDLIN_DATA_DIR/functions/post_training_function.py
```

**Example:**

```python
def apply(config, data_dir, model, X_train, y_train, X_test, y_test):
    # Example: Generate and save confusion matrix
    from sklearn.metrics import confusion_matrix
    import matplotlib.pyplot as plt

    predictions = model.predict(X_test)
    cm = confusion_matrix(y_test, predictions.argmax(axis=1))

    plt.figure(figsize=(8, 8))
    plt.imshow(cm, cmap='Blues')
    plt.colorbar()
    plt.xlabel('Predicted')
    plt.ylabel('Actual')
    plt.title('Confusion Matrix')
    plt.savefig(f"{data_dir}/confusion_matrix.png")
```

---

## Pre-Prediction Function

**Purpose:** Prepares features and configurations before running predictions.

**Default Location:**

```
MAUDLIN_DATA_DIR/functions/pre_prediction_function.py
```

**Example:**

```python
def apply(config, folder, model):
    # Example: Load the latest model weights
    model.load_weights(f"{folder}/best_weights.h5")
    return model
```

---

## Post-Prediction Function

**Purpose:** Processes prediction outputs for reporting or refinement.

**Default Location:**

```
MAUDLIN_DATA_DIR/functions/post_prediction_function.py
```

**Example:**

```python
def apply(config, model, predictions, ground_truth, data_dir, input_features=None):
    # Example: Plot predictions vs ground truth
    import matplotlib.pyplot as plt

    plt.figure(figsize=(10, 6))
    plt.plot(ground_truth, label='Actual')
    plt.plot(predictions, label='Predicted')
    plt.legend()
    plt.title('Predictions vs Ground Truth')
    plt.savefig(f"{data_dir}/predictions_vs_ground_truth.png")
```

---

## Summary

By customizing these workflow functions, Maudlin allows you to adapt preprocessing, feature engineering, and result analysis to suit complex and domain-specific requirements. With support for flexible YAML-based configurations and Python-based processing scripts, Maudlin ensures that both training and inference pipelines are highly configurable and reproducible.

